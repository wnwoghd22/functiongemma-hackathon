# Low-F1 Analysis (Run 20260222_054900)

## Run Reference
- Benchmark log: `/Users/jaehong/Desktop/functiongemma-hackathon/benchmark_runs/benchmark_20260222_054900.md`
- Summary: `TOTAL SCORE 72.6%`, `avg F1 0.82`, `on-device 100%`
- Low-F1 cases in this run: `7/30`

## Low-F1 Cases
| Case | Difficulty | F1 | Primary Failure |
|---|---|---:|---|
| `message_among_three` | medium | 0.00 | Message argument over-generation |
| `alarm_among_three` | medium | 0.00 | Minute extraction loss (`:15 -> :00`) |
| `reminder_among_four` | medium | 0.00 | Wrong tool selected (`get_weather` vs `create_reminder`) |
| `alarm_and_weather` | hard | 0.50 | Alarm minute extraction loss (`:30 -> :00`) |
| `search_and_message` | hard | 0.50 | `search_contacts.query` type/value corruption |
| `alarm_and_reminder` | hard | 0.00 (log), 0.50 (replay) | Second action/tool mismatch + malformed args key |
| `timer_music_reminder` | hard | 0.67 | Nested/invalid timer argument shape |

## Detailed Findings

### 1) `message_among_three` (F1 0.00)
- Expected: `send_message(recipient="John", message="hello")`
- Observed: `send_message` tool matched, but `message` became a long generic sentence.
- Likely root cause:
  - No strict clamp/canonicalization for `send_message.message`.
  - Model over-generates conversational boilerplate under ambiguity.
- Relevant code:
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:164`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:270`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:347`

### 2) `alarm_among_three` and `alarm_and_weather` (F1 0.00 / 0.50)
- Expected times include non-zero minutes (`8:15`, `7:30`).
- Observed alarm minute collapsed to `0`.
- Likely root cause:
  - Minute parsing path misses some phrasing/forms in multi-tool context.
  - Post-processing does not recover minute when hour is captured but minute is absent.
- Relevant code:
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:107`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:270`

### 3) `reminder_among_four` (F1 0.00)
- Expected: `create_reminder(title="call the dentist", time="2:00 PM")`
- Observed: `get_weather(location="city name")`
- Likely root cause:
  - Tool selection instability in many-tool contexts.
  - On-device route returns structurally valid but semantically wrong tool.
- Relevant code:
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:455`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:642`

### 4) `search_and_message` (F1 0.50)
- Expected: `search_contacts(query="Tom")` + `send_message(...)`
- Observed: `query` sometimes becomes non-string/non-name value (e.g. numeric).
- Likely root cause:
  - Missing strict type coercion/validation for `search_contacts.query`.
  - Sanitization trims strings and abs(int), but does not enforce schema-specific value repair.
- Relevant code:
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:259`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:347`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:642`

### 5) `alarm_and_reminder` (F1 0.00 in log; replay drifted to 0.50)
- Expected second action: `create_reminder(...)`
- Observed issues:
  - Wrong second tool or malformed key like `recipient：<escape>...`.
- Likely root cause:
  - JSON repair path can leave corrupted keys/shape in edge outputs.
  - Multi-action second-call extraction not strictly schema-corrected.
- Relevant code:
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:335`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:577`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:642`

### 6) `timer_music_reminder` (F1 0.67)
- Expected: `set_timer(minutes=15)`
- Observed: nested invalid shape like `{"minutes": {"minutes": -15}}`.
- Likely root cause:
  - `set_timer.minutes` flattening/normalization is missing when model emits nested objects.
- Relevant code:
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:270`
  - `/Users/jaehong/Desktop/functiongemma-hackathon/main.py:347`

## Cross-Cutting Pattern
- Most misses are not “no call” failures; they are **argument fidelity** and **tool choice drift** failures.
- Cloud fallback gate is triggered for several risky cases, but local environment DNS blocks cloud request (`generativelanguage.googleapis.com`), so rescue does not happen in local runs.

## Priority Fix List (for next patch)
1. Enforce schema-aware coercion post-pass:
   - `search_contacts.query` must be non-empty string.
   - `set_timer.minutes` must flatten nested dict and convert to non-negative int.
2. Tighten alarm minute extraction/repair:
   - preserve `:15`, `:30`, `:45` reliably in mixed-intent prompts.
3. Add targeted clamp for `send_message.message`:
   - strip boilerplate and keep concise extracted payload when explicit `"saying ..."` exists.
4. Strengthen reminder intent override:
   - if utterance contains clear `remind` marker, prefer `create_reminder` over weather/music in many-tool sets.
5. Harden repaired-key sanitizer:
   - reject malformed keys containing escape artifacts and rebuild args from rule-based extractor.
