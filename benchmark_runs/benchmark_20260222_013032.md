# Benchmark Run - 20260222_013032

## Command
```bash
python /Users/jaehong/Desktop/functiongemma-hackathon/scripts/benchmark_strategy.py --strategy strategies.strategy_selective 
```

## Output
```text
[1/30] Running: weather_sf (easy)... F1=1.00 | 249ms | on-device
[2/30] Running: alarm_10am (easy)... F1=1.00 | 935ms | cloud (fallback)
[3/30] Running: message_alice (easy)... F1=1.00 | 1124ms | cloud (fallback)
[4/30] Running: weather_london (easy)... F1=1.00 | 243ms | on-device
[5/30] Running: alarm_6am (easy)... F1=1.00 | 1450ms | cloud (fallback)
[6/30] Running: play_bohemian (easy)... F1=1.00 | 303ms | on-device
[7/30] Running: timer_5min (easy)... F1=1.00 | 921ms | cloud (fallback)
[8/30] Running: reminder_meeting (easy)... F1=1.00 | 872ms | cloud (fallback)
[9/30] Running: search_bob (easy)... F1=1.00 | 522ms | cloud (fallback)
[10/30] Running: weather_paris (easy)... F1=1.00 | 674ms | cloud (fallback)
[11/30] Running: message_among_three (medium)... F1=1.00 | 740ms | cloud (fallback)
[12/30] Running: weather_among_two (medium)... F1=1.00 | 913ms | cloud (fallback)
[13/30] Running: alarm_among_three (medium)... F1=1.00 | 1228ms | cloud (fallback)
[14/30] Running: music_among_three (medium)... F1=1.00 | 1305ms | cloud (fallback)
[15/30] Running: reminder_among_four (medium)... F1=1.00 | 1739ms | cloud (fallback)
[16/30] Running: timer_among_three (medium)... F1=1.00 | 344ms | on-device
[17/30] Running: search_among_four (medium)... F1=1.00 | 1541ms | cloud (fallback)
[18/30] Running: weather_among_four (medium)... F1=1.00 | 384ms | on-device
[19/30] Running: message_among_four (medium)... F1=0.00 | 1291ms | cloud (fallback)
[20/30] Running: alarm_among_five (medium)... F1=1.00 | 438ms | on-device
[21/30] Running: message_and_weather (hard)... F1=1.00 | 847ms | cloud (fallback)
[22/30] Running: alarm_and_weather (hard)... F1=1.00 | 1258ms | cloud (fallback)
[23/30] Running: timer_and_music (hard)... F1=1.00 | 1157ms | cloud (fallback)
[24/30] Running: reminder_and_message (hard)... F1=1.00 | 763ms | cloud (fallback)
[25/30] Running: search_and_message (hard)... F1=1.00 | 1596ms | cloud (fallback)
[26/30] Running: alarm_and_reminder (hard)... F1=1.00 | 1333ms | cloud (fallback)
[27/30] Running: weather_and_music (hard)... F1=1.00 | 850ms | cloud (fallback)
[28/30] Running: message_weather_alarm (hard)... F1=0.67 | 1982ms | cloud (fallback)
[29/30] Running: timer_music_reminder (hard)... F1=1.00 | 1574ms | cloud (fallback)
[30/30] Running: search_message_weather (hard)... F1=1.00 | 1719ms | cloud (fallback)

=== Benchmark Results ===

   # | Difficulty | Name                         |  Time (ms) |    F1 | Source
  ---+------------+------------------------------+------------+-------+---------------------
   1 | easy       | weather_sf                   |     248.62 |  1.00 | on-device
   2 | easy       | alarm_10am                   |     935.46 |  1.00 | cloud (fallback)
   3 | easy       | message_alice                |    1124.37 |  1.00 | cloud (fallback)
   4 | easy       | weather_london               |     242.65 |  1.00 | on-device
   5 | easy       | alarm_6am                    |    1450.22 |  1.00 | cloud (fallback)
   6 | easy       | play_bohemian                |     302.75 |  1.00 | on-device
   7 | easy       | timer_5min                   |     921.34 |  1.00 | cloud (fallback)
   8 | easy       | reminder_meeting             |     872.37 |  1.00 | cloud (fallback)
   9 | easy       | search_bob                   |     522.09 |  1.00 | cloud (fallback)
  10 | easy       | weather_paris                |     674.48 |  1.00 | cloud (fallback)
  11 | medium     | message_among_three          |     739.65 |  1.00 | cloud (fallback)
  12 | medium     | weather_among_two            |     912.94 |  1.00 | cloud (fallback)
  13 | medium     | alarm_among_three            |    1228.22 |  1.00 | cloud (fallback)
  14 | medium     | music_among_three            |    1305.09 |  1.00 | cloud (fallback)
  15 | medium     | reminder_among_four          |    1738.83 |  1.00 | cloud (fallback)
  16 | medium     | timer_among_three            |     343.64 |  1.00 | on-device
  17 | medium     | search_among_four            |    1541.00 |  1.00 | cloud (fallback)
  18 | medium     | weather_among_four           |     383.65 |  1.00 | on-device
  19 | medium     | message_among_four           |    1290.72 |  0.00 | cloud (fallback)
  20 | medium     | alarm_among_five             |     437.80 |  1.00 | on-device
  21 | hard       | message_and_weather          |     847.22 |  1.00 | cloud (fallback)
  22 | hard       | alarm_and_weather            |    1257.75 |  1.00 | cloud (fallback)
  23 | hard       | timer_and_music              |    1157.35 |  1.00 | cloud (fallback)
  24 | hard       | reminder_and_message         |     762.98 |  1.00 | cloud (fallback)
  25 | hard       | search_and_message           |    1596.36 |  1.00 | cloud (fallback)
  26 | hard       | alarm_and_reminder           |    1332.57 |  1.00 | cloud (fallback)
  27 | hard       | weather_and_music            |     849.77 |  1.00 | cloud (fallback)
  28 | hard       | message_weather_alarm        |    1981.60 |  0.67 | cloud (fallback)
  29 | hard       | timer_music_reminder         |    1574.41 |  1.00 | cloud (fallback)
  30 | hard       | search_message_weather       |    1719.34 |  1.00 | cloud (fallback)

--- Summary ---
  easy     avg F1=1.00  avg time=729.44ms  on-device=3/10 cloud=7/10
  medium   avg F1=0.90  avg time=992.15ms  on-device=3/10 cloud=7/10
  hard     avg F1=0.97  avg time=1307.94ms  on-device=0/10 cloud=10/10
  overall  avg F1=0.96  avg time=1009.84ms  total time=30295.25ms
           on-device=6/30 (20%)  cloud=24/30 (80%)

==================================================
  TOTAL SCORE: 60.9%
==================================================
```

## Exit Status
`0`

## Analysis: strategy_selective v2.1

### Version History

| Version | Change                                          | F1   | On-device | Score |
|---------|------------------------------------------------|------|-----------|-------|
| v1      | No confidence gate, empty-call kept on-device  | 0.76 | 43%       | 56.1% |
| v2      | +tool-count gate, +moderate conf gate (no effect) | 0.72 | 43%     | 54.9% |
| v2.1    | Empty calls always → cloud                     | 0.96 | 20%       | **60.9%** |
| balanced| Reference                                      | 0.94 | 20%       | 59.9% |

### Key Finding

The main failure mode in v1/v2 was **empty calls with high confidence** (conf > 0.95).
The local model's confidence score is unreliable for empty-call detection — it reports
high confidence even when it produces no function calls (refusal/clarification behavior).
Confidence-based gating cannot catch this; the fix is structural: empty calls + tools = cloud.

### v2.1 vs balanced Comparison

| Metric           | balanced | selective v2.1 | Delta  |
|------------------|----------|----------------|--------|
| Avg F1           | 0.94     | **0.96**       | +0.02  |
| Avg Time (ms)    | 1325     | **1010**       | -315   |
| On-device ratio  | 20%      | 20%            | 0      |
| Total Score      | 59.9%    | **60.9%**      | +1.0%  |

### Per-Difficulty

| Difficulty | F1   | On-device | Avg Time |
|------------|------|-----------|----------|
| easy       | 1.00 | 3/10      | 729ms    |
| medium     | 0.90 | 3/10      | 992ms    |
| hard       | 0.97 | 0/10      | 1308ms   |

### Remaining Failures (2 cases)

| Case                  | Diff   | F1   | Source | Note                              |
|-----------------------|--------|------|--------|-----------------------------------|
| message_among_four    | medium | 0.00 | cloud  | Cloud string matching failure     |
| message_weather_alarm | hard   | 0.67 | cloud  | Partial match (2/3 calls)         |

Both failures are cloud-side — routing logic cannot fix these (strict string matching issue).

### Why Score Improved Over Balanced

1. Simpler gate logic → fewer false positives in cloud routing.
2. Single cloud model (flash-lite only) → lower average latency.
3. Same on-device ratio but higher F1 and faster time → net score gain.

### Next Optimization Vectors

- On-device ratio is the bottleneck (20%). Score formula gives 25% weight to it.
- 6 on-device cases: weather_sf, weather_london, play_bohemian, timer_among_three,
  weather_among_four, alarm_among_five. All are cases where local produced valid calls.
- To increase on-device ratio, need to identify which cloud-routed cases local would
  have gotten right anyway (currently ~14 empty-call cases go to cloud unnecessarily
  because local cannot produce calls at all — this is a model limitation, not routing).
