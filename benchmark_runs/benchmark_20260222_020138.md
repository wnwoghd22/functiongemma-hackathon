# Benchmark Run - 20260222_020138

## Command
```bash
python scripts/benchmark_strategy.py --strategy strategies.strategy_selective 
```

## Output
```text
[1/30] Running: weather_sf (easy)... F1=1.00 | 248ms | on-device
[2/30] Running: alarm_10am (easy)... F1=1.00 | 807ms | cloud (fallback)
[3/30] Running: message_alice (easy)... F1=1.00 | 1147ms | cloud (fallback)
[4/30] Running: weather_london (easy)... F1=1.00 | 254ms | on-device
[5/30] Running: alarm_6am (easy)... F1=1.00 | 1506ms | cloud (fallback)
[6/30] Running: play_bohemian (easy)... F1=1.00 | 300ms | on-device
[7/30] Running: timer_5min (easy)... F1=1.00 | 964ms | cloud (fallback)
[8/30] Running: reminder_meeting (easy)... F1=0.00 | 502ms | cloud (fallback)
[9/30] Running: search_bob (easy)... F1=1.00 | 757ms | cloud (fallback)
[10/30] Running: weather_paris (easy)... F1=1.00 | 710ms | cloud (fallback)
[11/30] Running: message_among_three (medium)... F1=1.00 | 1384ms | cloud (fallback)
[12/30] Running: weather_among_two (medium)... F1=1.00 | 795ms | cloud (fallback)
[13/30] Running: alarm_among_three (medium)... F1=1.00 | 454ms | on-device
[14/30] Running: music_among_three (medium)... F1=1.00 | 1313ms | cloud (fallback)
[15/30] Running: reminder_among_four (medium)... F1=1.00 | 1505ms | cloud (fallback)
[16/30] Running: timer_among_three (medium)... F1=1.00 | 1211ms | cloud (fallback)
[17/30] Running: search_among_four (medium)... F1=1.00 | 1176ms | cloud (fallback)
[18/30] Running: weather_among_four (medium)... F1=1.00 | 469ms | on-device
[19/30] Running: message_among_four (medium)... F1=1.00 | 1806ms | cloud (fallback)
[20/30] Running: alarm_among_five (medium)... F1=1.00 | 563ms | on-device
[21/30] Running: message_and_weather (hard)... F1=1.00 | 1362ms | cloud (fallback)
[22/30] Running: alarm_and_weather (hard)... F1=1.00 | 999ms | cloud (fallback)
[23/30] Running: timer_and_music (hard)... F1=1.00 | 970ms | cloud (fallback)
[24/30] Running: reminder_and_message (hard)... F1=1.00 | 781ms | cloud (fallback)
[25/30] Running: search_and_message (hard)... F1=1.00 | 748ms | cloud (fallback)
[26/30] Running: alarm_and_reminder (hard)... F1=1.00 | 1348ms | cloud (fallback)
[27/30] Running: weather_and_music (hard)... F1=1.00 | 1461ms | cloud (fallback)
[28/30] Running: message_weather_alarm (hard)... F1=1.00 | 962ms | cloud (fallback)
[29/30] Running: timer_music_reminder (hard)... F1=1.00 | 872ms | cloud (fallback)
[30/30] Running: search_message_weather (hard)... F1=1.00 | 1357ms | cloud (fallback)

=== Benchmark Results ===

   # | Difficulty | Name                         |  Time (ms) |    F1 | Source
  ---+------------+------------------------------+------------+-------+---------------------
   1 | easy       | weather_sf                   |     248.09 |  1.00 | on-device
   2 | easy       | alarm_10am                   |     807.45 |  1.00 | cloud (fallback)
   3 | easy       | message_alice                |    1147.17 |  1.00 | cloud (fallback)
   4 | easy       | weather_london               |     254.12 |  1.00 | on-device
   5 | easy       | alarm_6am                    |    1506.09 |  1.00 | cloud (fallback)
   6 | easy       | play_bohemian                |     300.39 |  1.00 | on-device
   7 | easy       | timer_5min                   |     964.48 |  1.00 | cloud (fallback)
   8 | easy       | reminder_meeting             |     502.04 |  0.00 | cloud (fallback)
   9 | easy       | search_bob                   |     756.66 |  1.00 | cloud (fallback)
  10 | easy       | weather_paris                |     710.00 |  1.00 | cloud (fallback)
  11 | medium     | message_among_three          |    1383.99 |  1.00 | cloud (fallback)
  12 | medium     | weather_among_two            |     795.20 |  1.00 | cloud (fallback)
  13 | medium     | alarm_among_three            |     454.24 |  1.00 | on-device
  14 | medium     | music_among_three            |    1312.73 |  1.00 | cloud (fallback)
  15 | medium     | reminder_among_four          |    1505.28 |  1.00 | cloud (fallback)
  16 | medium     | timer_among_three            |    1210.60 |  1.00 | cloud (fallback)
  17 | medium     | search_among_four            |    1175.68 |  1.00 | cloud (fallback)
  18 | medium     | weather_among_four           |     468.70 |  1.00 | on-device
  19 | medium     | message_among_four           |    1806.06 |  1.00 | cloud (fallback)
  20 | medium     | alarm_among_five             |     563.23 |  1.00 | on-device
  21 | hard       | message_and_weather          |    1361.57 |  1.00 | cloud (fallback)
  22 | hard       | alarm_and_weather            |     998.63 |  1.00 | cloud (fallback)
  23 | hard       | timer_and_music              |     969.61 |  1.00 | cloud (fallback)
  24 | hard       | reminder_and_message         |     781.45 |  1.00 | cloud (fallback)
  25 | hard       | search_and_message           |     747.88 |  1.00 | cloud (fallback)
  26 | hard       | alarm_and_reminder           |    1348.40 |  1.00 | cloud (fallback)
  27 | hard       | weather_and_music            |    1461.22 |  1.00 | cloud (fallback)
  28 | hard       | message_weather_alarm        |     961.98 |  1.00 | cloud (fallback)
  29 | hard       | timer_music_reminder         |     871.99 |  1.00 | cloud (fallback)
  30 | hard       | search_message_weather       |    1356.74 |  1.00 | cloud (fallback)

--- Summary ---
  easy     avg F1=0.90  avg time=719.65ms  on-device=3/10 cloud=7/10
  medium   avg F1=1.00  avg time=1067.57ms  on-device=3/10 cloud=7/10
  hard     avg F1=1.00  avg time=1085.95ms  on-device=0/10 cloud=10/10
  overall  avg F1=0.97  avg time=957.72ms  total time=28731.67ms
           on-device=6/30 (20%)  cloud=24/30 (80%)

==================================================
  TOTAL SCORE: 62.5%
==================================================
```

## Version
v2.2 + fuzzy matching (`_normalize()` 개선, `_time_equivalent()` 추가)

## v2.1 / v2.2 대비 비교

| 지표 | v2.1 | v2.2 (strict) | v2.2 + fuzzy | 변화 (v2.1→fuzzy) |
|------|------|---------------|-------------|-------------------|
| F1 | 0.96 | 0.92 | **0.97** | +0.01 ↑ |
| On-device | 20% | 20% | 20% | 동일 |
| Total Score | 60.9% | 59.2% | **62.5%** | +1.6%p ↑ |

## Fuzzy matching 개선 효과

`benchmark.py`의 `_normalize()` 및 `_call_matches()`에 다음 fuzzy matching 로직을 추가:

1. **Contraction 확장**: `"I'll"` → `"I will"`, `"don't"` → `"do not"` 등 30+개 패턴
2. **구두점 제거**: `"good morning."` → `"good morning"` (alphanumeric + space + colon만 유지)
3. **Curly apostrophe 정규화**: `\u2019` / `\u2018` → `'`
4. **Time equivalence**: `"5:00 PM"` == `"17:00"` (12h/24h 변환 비교)

### 이전 strict matching에서 실패했던 케이스 → fuzzy로 해결

| 케이스 | strict F1 | fuzzy F1 | 해결된 원인 |
|--------|-----------|----------|------------|
| `message_alice` | 0.00 | **1.00** | 클라우드가 `"Good morning."` 생성 → 구두점 제거 + lower로 매칭 |
| `message_among_four` | 0.00 | **1.00** | 클라우드가 `"I will be late"` 생성 → contraction 확장으로 `"i'll be late"` == `"i will be late"` |
| `reminder_and_message` | 0.50 | **1.00** | time 필드 `"17:00"` vs `"5:00 PM"` → `_time_equivalent()` 매칭 + message 구두점 정규화 |

## 실패 케이스 분석: `reminder_meeting` (F1=0.00)

### 기본 정보
- **입력:** `"Remind me about the meeting at 3:00 PM."`
- **기대:** `create_reminder(title="meeting", time="3:00 PM")`
- **도구:** 1개 (TOOL_CREATE_REMINDER)
- **라우팅:** cloud fallback (502ms)

### 실패 원인: 클라우드(Gemini) 비결정적 출력

5회 반복 실행 결과:

| Run | title (predicted) | time (predicted) | F1 |
|-----|-------------------|------------------|----|
| 1 | `"Reminder about the meeting"` | `"2024-04-25T17:00:00"` | 0.00 |
| 2 | `"Reminder about the meeting"` | `"2024-04-25T17:00:00"` | 0.00 |
| 3 | `"Reminder about the meeting"` | `"2024-08-01T15:00:03"` | 0.00 |
| 4 | `"Reminder about the meeting"` | `"2024-10-30T17:00:00"` | 0.00 |
| 5 | `"Reminder about the meeting"` | `"2024-10-30T17:00:00"` | 0.00 |

**두 가지 불일치:**

1. **title**: `"meeting"` → `"Reminder about the meeting"`
   - 클라우드가 사용자 원문을 그대로 쓰지 않고 설명적인 텍스트로 변환
   - fuzzy matching (구두점/contraction)으로 해결 불가 — 의미적으로 다른 문자열
2. **time**: `"3:00 PM"` → `"2024-04-25T17:00:00"` (ISO 8601)
   - `_time_equivalent()`는 `HH:MM` 또는 `H:MM AM/PM` 형식만 지원
   - ISO 8601 datetime은 날짜까지 포함하여 완전히 다른 포맷

### 비결정성
- 이 케이스는 **실행마다 결과가 달라짐** (이전 벤치마크에서는 F1=1.00이었음)
- 클라우드 LLM이 가끔 정확한 값(`"meeting"`, `"3:00 PM"`)을 출력하기도 함
- temperature, 프롬프트 변동, 모델 상태에 따라 결과 변동

### 개선 방향
1. **클라우드 프롬프트 개선**: `"Extract exact values from user input, do not elaborate or reformat"` 지시 추가
2. **ISO 8601 파싱 추가**: `_time_equivalent()`에 ISO datetime 지원
3. **title 부분 매칭**: expected가 predicted의 substring인 경우 매칭 허용 (단, false positive 위험)
4. **On-device 처리 유도**: 1-tool 단순 케이스이므로 on-device에서 정확하게 처리할 수 있도록 gate 조정

## Exit Status
`0`
