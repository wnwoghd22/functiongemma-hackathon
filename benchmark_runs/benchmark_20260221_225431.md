# Benchmark Run - 20260221_225431

## Command
```bash
python /Users/jaehong/Desktop/functiongemma-hackathon/scripts/benchmark_strategy.py --strategy strategies.strategy_selective 
```

## Output
```text
[1/30] Running: weather_sf (easy)... F1=1.00 | 254ms | on-device
[2/30] Running: alarm_10am (easy)... F1=1.00 | 901ms | cloud (fallback)
[3/30] Running: message_alice (easy)... F1=0.00 | 355ms | on-device
[4/30] Running: weather_london (easy)... F1=1.00 | 235ms | on-device
[5/30] Running: alarm_6am (easy)... F1=0.00 | 687ms | on-device
[6/30] Running: play_bohemian (easy)... F1=1.00 | 289ms | on-device
[7/30] Running: timer_5min (easy)... F1=1.00 | 1115ms | cloud (fallback)
[8/30] Running: reminder_meeting (easy)... F1=1.00 | 831ms | cloud (fallback)
[9/30] Running: search_bob (easy)... F1=1.00 | 1179ms | cloud (fallback)
[10/30] Running: weather_paris (easy)... F1=1.00 | 991ms | cloud (fallback)
[11/30] Running: message_among_three (medium)... F1=1.00 | 778ms | cloud (fallback)
[12/30] Running: weather_among_two (medium)... F1=0.00 | 310ms | on-device
[13/30] Running: alarm_among_three (medium)... F1=1.00 | 1431ms | cloud (fallback)
[14/30] Running: music_among_three (medium)... F1=0.00 | 572ms | on-device
[15/30] Running: reminder_among_four (medium)... F1=0.00 | 917ms | on-device
[16/30] Running: timer_among_three (medium)... F1=1.00 | 372ms | on-device
[17/30] Running: search_among_four (medium)... F1=0.00 | 896ms | on-device
[18/30] Running: weather_among_four (medium)... F1=1.00 | 391ms | on-device
[19/30] Running: message_among_four (medium)... F1=0.00 | 601ms | on-device
[20/30] Running: alarm_among_five (medium)... F1=1.00 | 438ms | on-device
[21/30] Running: message_and_weather (hard)... F1=1.00 | 1120ms | cloud (fallback)
[22/30] Running: alarm_and_weather (hard)... F1=1.00 | 1872ms | cloud (fallback)
[23/30] Running: timer_and_music (hard)... F1=1.00 | 1276ms | cloud (fallback)
[24/30] Running: reminder_and_message (hard)... F1=1.00 | 1372ms | cloud (fallback)
[25/30] Running: search_and_message (hard)... F1=1.00 | 1580ms | cloud (fallback)
[26/30] Running: alarm_and_reminder (hard)... F1=1.00 | 1820ms | cloud (fallback)
[27/30] Running: weather_and_music (hard)... F1=1.00 | 850ms | cloud (fallback)
[28/30] Running: message_weather_alarm (hard)... F1=0.67 | 1881ms | cloud (fallback)
[29/30] Running: timer_music_reminder (hard)... F1=1.00 | 1549ms | cloud (fallback)
[30/30] Running: search_message_weather (hard)... F1=1.00 | 1731ms | cloud (fallback)

=== Benchmark Results ===

   # | Difficulty | Name                         |  Time (ms) |    F1 | Source
  ---+------------+------------------------------+------------+-------+---------------------
   1 | easy       | weather_sf                   |     254.42 |  1.00 | on-device
   2 | easy       | alarm_10am                   |     901.31 |  1.00 | cloud (fallback)
   3 | easy       | message_alice                |     354.91 |  0.00 | on-device
   4 | easy       | weather_london               |     234.65 |  1.00 | on-device
   5 | easy       | alarm_6am                    |     687.05 |  0.00 | on-device
   6 | easy       | play_bohemian                |     288.83 |  1.00 | on-device
   7 | easy       | timer_5min                   |    1114.58 |  1.00 | cloud (fallback)
   8 | easy       | reminder_meeting             |     831.32 |  1.00 | cloud (fallback)
   9 | easy       | search_bob                   |    1178.83 |  1.00 | cloud (fallback)
  10 | easy       | weather_paris                |     990.96 |  1.00 | cloud (fallback)
  11 | medium     | message_among_three          |     778.13 |  1.00 | cloud (fallback)
  12 | medium     | weather_among_two            |     309.96 |  0.00 | on-device
  13 | medium     | alarm_among_three            |    1430.63 |  1.00 | cloud (fallback)
  14 | medium     | music_among_three            |     571.61 |  0.00 | on-device
  15 | medium     | reminder_among_four          |     916.56 |  0.00 | on-device
  16 | medium     | timer_among_three            |     371.67 |  1.00 | on-device
  17 | medium     | search_among_four            |     895.50 |  0.00 | on-device
  18 | medium     | weather_among_four           |     391.08 |  1.00 | on-device
  19 | medium     | message_among_four           |     600.92 |  0.00 | on-device
  20 | medium     | alarm_among_five             |     438.31 |  1.00 | on-device
  21 | hard       | message_and_weather          |    1119.56 |  1.00 | cloud (fallback)
  22 | hard       | alarm_and_weather            |    1871.64 |  1.00 | cloud (fallback)
  23 | hard       | timer_and_music              |    1276.15 |  1.00 | cloud (fallback)
  24 | hard       | reminder_and_message         |    1372.33 |  1.00 | cloud (fallback)
  25 | hard       | search_and_message           |    1579.59 |  1.00 | cloud (fallback)
  26 | hard       | alarm_and_reminder           |    1819.79 |  1.00 | cloud (fallback)
  27 | hard       | weather_and_music            |     850.28 |  1.00 | cloud (fallback)
  28 | hard       | message_weather_alarm        |    1880.97 |  0.67 | cloud (fallback)
  29 | hard       | timer_music_reminder         |    1549.40 |  1.00 | cloud (fallback)
  30 | hard       | search_message_weather       |    1731.25 |  1.00 | cloud (fallback)

--- Summary ---
  easy     avg F1=0.80  avg time=683.68ms  on-device=5/10 cloud=5/10
  medium   avg F1=0.50  avg time=670.44ms  on-device=8/10 cloud=2/10
  hard     avg F1=0.97  avg time=1505.10ms  on-device=0/10 cloud=10/10
  overall  avg F1=0.76  avg time=953.07ms  total time=28592.18ms
           on-device=13/30 (43%)  cloud=17/30 (57%)

==================================================
  TOTAL SCORE: 56.1%
==================================================
```

## Exit Status
`0`

## Analysis: strategy_selective vs strategy_balanced

### Score Comparison

| Metric           | balanced | selective | Delta   |
|------------------|----------|-----------|---------|
| Avg F1           | 0.94     | 0.76      | **-0.18** |
| Avg Time (ms)    | 1325     | 953       | -372    |
| On-device ratio  | 20%      | 43%       | **+23%**  |
| Total Score      | 59.9%    | 56.1%     | -3.8%   |

### Per-Difficulty Breakdown

| Difficulty | balanced F1 | selective F1 | selective on-device |
|------------|-------------|--------------|---------------------|
| easy       | ~0.94       | 0.80         | 5/10 (50%)          |
| medium     | ~0.94       | 0.50         | 8/10 (80%)          |
| hard       | ~0.97       | 0.97         | 0/10 (0%)           |

### Failure Cases (selective, F1 < 1.0)

| Case                   | Diff   | F1   | Source    | Failure Type               |
|------------------------|--------|------|-----------|----------------------------|
| message_alice          | easy   | 0.00 | on-device | Wrong call / arg mismatch  |
| alarm_6am              | easy   | 0.00 | on-device | Wrong call / arg mismatch  |
| weather_among_two      | medium | 0.00 | on-device | Tool selection error       |
| music_among_three      | medium | 0.00 | on-device | Tool selection error       |
| reminder_among_four    | medium | 0.00 | on-device | Tool selection error       |
| search_among_four      | medium | 0.00 | on-device | Tool selection error       |
| message_among_four     | medium | 0.00 | on-device | Tool selection error       |
| message_weather_alarm  | hard   | 0.67 | cloud     | Partial match (2/3 calls)  |

### Root Cause

1. **Confidence gate removal was too aggressive**: `strategy_balanced` used a soft confidence
   threshold (`< 0.85`) to catch cases where the local model produced structurally valid but
   semantically wrong output. `strategy_selective` removed this gate entirely, trusting any
   structurally valid local output.

2. **Medium cases (`*_among_*`) are tool-selection tasks**: These present multiple tools and
   require selecting the correct one. Local model often picks the wrong tool with moderate
   confidence. Without a confidence gate, these stay on-device and score F1=0.

3. **Easy failures (`message_alice`, `alarm_6am`)**: Local model produces valid-looking calls
   with wrong argument values. No structural gate catches this.

### Key Insight

The score formula weights F1 at **60%** vs on-device ratio at **25%**. Each F1=0 failure costs
more than the on-device bonus gained by keeping it local. The optimal strategy must find the
**minimum confidence threshold** that catches semantically wrong outputs without over-routing
to cloud.

### Next Steps

- Reintroduce a **moderate confidence gate** (e.g., `< 0.7`) that only triggers for
  single-action cases where local is structurally valid but low-confidence.
- Consider a **tool-count gate**: when `len(tools) >= 3` and local confidence is below a
  threshold, the tool-selection risk is higher — fallback to cloud.
- Target: on-device ~40%, F1 ~0.90+ → expected score improvement over both strategies.
